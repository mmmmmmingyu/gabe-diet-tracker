<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡è´¦å•è®°è´¦å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .upload-area {
            background: white;
            border: 2px dashed #07c160;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            background: #f0fff5;
        }
        .upload-area input {
            display: none;
        }
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
        }
        .stat-card.income .value { color: #07c160; }
        .stat-card.expense .value { color: #ff4d4f; }
        .stat-card.balance .value { color: #1890ff; }
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chart-card h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .category-list {
            list-style: none;
        }
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .category-item:last-child {
            border-bottom: none;
        }
        .category-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .category-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .category-amount {
            text-align: right;
        }
        .category-amount .amount {
            font-weight: bold;
            color: #333;
        }
        .category-amount .percent {
            font-size: 12px;
            color: #999;
        }
        .progress-bar {
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s;
        }
        .transactions {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .transactions-header {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #d9d9d9;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .filter-btn.active {
            background: #07c160;
            color: white;
            border-color: #07c160;
        }
        .transaction-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .transaction-item:hover {
            background: #f5f5f5;
        }
        .transaction-info {
            flex: 1;
        }
        .transaction-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        .transaction-meta {
            font-size: 12px;
            color: #999;
        }
        .transaction-amount {
            font-weight: bold;
            font-size: 16px;
        }
        .transaction-amount.expense { color: #ff4d4f; }
        .transaction-amount.income { color: #07c160; }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .month-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .month-btn {
            padding: 8px 16px;
            border: 1px solid #d9d9d9;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        .month-btn.active {
            background: #07c160;
            color: white;
            border-color: #07c160;
        }
        .add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #07c160;
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(7, 193, 96, 0.4);
            transition: transform 0.2s;
        }
        .add-btn:hover {
            transform: scale(1.1);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
        }
        .modal-content h3 {
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-size: 16px;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .form-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-primary {
            background: #07c160;
            color: white;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        .pie-chart {
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        @media (max-width: 768px) {
            .charts {
                grid-template-columns: 1fr;
            }
            .stats-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’° å¾®ä¿¡è´¦å•è®°è´¦å·¥å…·</h1>
        
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFile(event)">
            <p style="font-size: 48px; margin-bottom: 10px;">ğŸ“</p>
            <p>ç‚¹å‡»ä¸Šä¼ å¾®ä¿¡è´¦å• Excel æ–‡ä»¶</p>
            <p style="color: #999; font-size: 14px; margin-top: 10px;">æ”¯æŒ .xlsx, .xls, .csv æ ¼å¼</p>
        </div>

        <div class="month-selector" id="monthSelector"></div>

        <div class="stats-cards" id="statsCards" style="display: none;">
            <div class="stat-card income">
                <h3>æ€»æ”¶å…¥</h3>
                <div class="value" id="totalIncome">Â¥0.00</div>
            </div>
            <div class="stat-card expense">
                <h3>æ€»æ”¯å‡º</h3>
                <div class="value" id="totalExpense">Â¥0.00</div>
            </div>
            <div class="stat-card balance">
                <h3>å‡€æ”¶æ”¯</h3>
                <div class="value" id="netBalance">Â¥0.00</div>
            </div>
            <div class="stat-card">
                <h3>äº¤æ˜“ç¬”æ•°</h3>
                <div class="value" id="transactionCount">0</div>
            </div>
        </div>

        <div class="charts" id="charts" style="display: none;">
            <div class="chart-card">
                <h3>ğŸ“Š æ”¯å‡ºåˆ†ç±»</h3>
                <ul class="category-list" id="categoryList"></ul>
            </div>
            <div class="chart-card">
                <h3>ğŸª ä¸»è¦å•†æˆ·</h3>
                <ul class="category-list" id="merchantList"></ul>
            </div>
        </div>

        <div class="transactions" id="transactions" style="display: none;">
            <div class="transactions-header">
                <h3>ğŸ“‹ äº¤æ˜“æ˜ç»†</h3>
                <div>
                    <button class="filter-btn active" onclick="filterTransactions('all')">å…¨éƒ¨</button>
                    <button class="filter-btn" onclick="filterTransactions('expense')">æ”¯å‡º</button>
                    <button class="filter-btn" onclick="filterTransactions('income')">æ”¶å…¥</button>
                </div>
            </div>
            <div class="transaction-list" id="transactionList"></div>
        </div>

        <div class="empty-state" id="emptyState">
            <p style="font-size: 48px; margin-bottom: 10px;">ğŸ“Š</p>
            <p>ä¸Šä¼ å¾®ä¿¡è´¦å•æ–‡ä»¶å¼€å§‹è®°è´¦</p>
        </div>
    </div>

    <button class="add-btn" onclick="openModal()">+</button>

    <div class="modal" id="addModal">
        <div class="modal-content">
            <h3>è®°ä¸€ç¬”</h3>
            <div class="form-group">
                <label>ç±»å‹</label>
                <select id="newType">
                    <option value="expense">æ”¯å‡º</option>
                    <option value="income">æ”¶å…¥</option>
                </select>
            </div>
            <div class="form-group">
                <label>é‡‘é¢</label>
                <input type="number" id="newAmount" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label>å•†æˆ·/å¯¹æ–¹</label>
                <input type="text" id="newMerchant" placeholder="å¦‚ï¼šè¶…å¸‚ã€å·¥èµ„">
            </div>
            <div class="form-group">
                <label>åˆ†ç±»</label>
                <select id="newCategory">
                    <option value="é¤é¥®">é¤é¥®</option>
                    <option value="äº¤é€š">äº¤é€š</option>
                    <option value="è´­ç‰©">è´­ç‰©</option>
                    <option value="å¨±ä¹">å¨±ä¹</option>
                    <option value="æ•™è‚²">æ•™è‚²</option>
                    <option value="åŒ»ç–—">åŒ»ç–—</option>
                    <option value="ä½æˆ¿">ä½æˆ¿</option>
                    <option value="è½¬è´¦">è½¬è´¦</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <input type="text" id="newNote" placeholder="å¯é€‰">
            </div>
            <div class="form-actions">
                <button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="addTransaction()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let allTransactions = [];
        let currentFilter = 'all';
        let currentMonth = 'all';

        // åˆ†ç±»å›¾æ ‡æ˜ å°„
        const categoryIcons = {
            'é¤é¥®': 'ğŸ”',
            'äº¤é€š': 'ğŸš—',
            'è´­ç‰©': 'ğŸ›ï¸',
            'å¨±ä¹': 'ğŸ®',
            'æ•™è‚²': 'ğŸ“š',
            'åŒ»ç–—': 'ğŸ¥',
            'ä½æˆ¿': 'ğŸ ',
            'è½¬è´¦': 'ğŸ’¸',
            'çº¢åŒ…': 'ğŸ§§',
            'å…¶ä»–': 'ğŸ“¦'
        };

        // åˆ†ç±»é¢œè‰²
        const categoryColors = [
            '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7',
            '#dfe6e9', '#fd79a8', '#fdcb6e', '#6c5ce7', '#a29bfe'
        ];

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    parseWeChatData(jsonData);
                } catch (error) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ˜¯å¾®ä¿¡è´¦å•æ–‡ä»¶');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseWeChatData(data) {
            // æ‰¾åˆ°è¡¨å¤´è¡Œï¼ˆé€šå¸¸æ˜¯ç¬¬17è¡Œï¼Œç´¢å¼•16ï¼‰
            let headerRow = -1;
            for (let i = 0; i < Math.min(data.length, 20); i++) {
                if (data[i] && data[i].includes('äº¤æ˜“æ—¶é—´')) {
                    headerRow = i;
                    break;
                }
            }

            if (headerRow === -1) {
                alert('æ— æ³•è¯†åˆ«è´¦å•æ ¼å¼');
                return;
            }

            const headers = data[headerRow];
            const transactions = [];

            for (let i = headerRow + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length < 6) continue;

                const time = row[0] || '';
                const type = row[1] || '';
                const merchant = row[2] || '';
                const product = row[3] || '';
                const direction = row[4] || '';
                const amountStr = row[5] || '0';

                if (!time || !direction) continue;

                const amount = parseFloat(amountStr.toString().replace('Â¥', '').replace(',', ''));
                
                transactions.push({
                    time: time,
                    type: type,
                    merchant: merchant,
                    product: product,
                    direction: direction,
                    amount: amount,
                    category: classifyTransaction(type, merchant, product)
                });
            }

            allTransactions = transactions;
            updateUI();
        }

        function classifyTransaction(type, merchant, product) {
            const text = (type + ' ' + merchant + ' ' + product).toLowerCase();
            
            if (text.includes('æ»´æ»´') || text.includes('åœ°é“') || text.includes('å…¬äº¤') || text.includes('å‡ºè¡Œ')) return 'äº¤é€š';
            if (text.includes('é¤') || text.includes('é¥­') || text.includes('é£Ÿ') || text.includes('å’–å•¡') || text.includes('å¥¶èŒ¶')) return 'é¤é¥®';
            if (text.includes('å±±å§†') || text.includes('è¶…å¸‚') || text.includes('è´­')) return 'è´­ç‰©';
            if (text.includes('æ•™è‚²') || text.includes('å­¦')) return 'æ•™è‚²';
            if (text.includes('çº¢åŒ…')) return 'çº¢åŒ…';
            if (text.includes('è½¬è´¦')) return 'è½¬è´¦';
            if (text.includes('ç¼´è´¹') || text.includes('æˆ¿ç§Ÿ')) return 'ä½æˆ¿';
            if (text.includes('åŒ»é™¢') || text.includes('è¯')) return 'åŒ»ç–—';
            if (text.includes('ç”µå½±') || text.includes('æ¸¸æˆ') || text.includes('æ£‹ç‰Œ')) return 'å¨±ä¹';
            
            return 'å…¶ä»–';
        }

        function updateUI() {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('statsCards').style.display = 'grid';
            document.getElementById('charts').style.display = 'grid';
            document.getElementById('transactions').style.display = 'block';

            updateMonthSelector();
            updateStats();
            updateCategories();
            updateMerchants();
            updateTransactionList();
        }

        function updateMonthSelector() {
            const months = new Set();
            allTransactions.forEach(t => {
                const month = t.time.substring(0, 7);
                months.add(month);
            });

            const selector = document.getElementById('monthSelector');
            selector.innerHTML = '<button class="month-btn active" onclick="selectMonth(\'all\')">å…¨éƒ¨</button>';
            
            Array.from(months).sort().forEach(month => {
                selector.innerHTML += `<button class="month-btn" onclick="selectMonth('${month}')">${month}</button>`;
            });
        }

        function selectMonth(month) {
            currentMonth = month;
            document.querySelectorAll('.month-btn').forEach(btn => {
                btn.classList.toggle('active', 
                    (month === 'all' && btn.textContent === 'å…¨éƒ¨') || 
                    btn.textContent === month);
            });
            updateStats();
            updateCategories();
            updateMerchants();
            updateTransactionList();
        }

        function getFilteredTransactions() {
            return allTransactions.filter(t => {
                const monthMatch = currentMonth === 'all' || t.time.substring(0, 7) === currentMonth;
                const typeMatch = currentFilter === 'all' || 
                    (currentFilter === 'expense' && t.direction === 'æ”¯å‡º') ||
                    (currentFilter === 'income' && t.direction === 'æ”¶å…¥');
                return monthMatch && typeMatch;
            });
        }

        function updateStats() {
            const filtered = getFilteredTransactions();
            const income = filtered.filter(t => t.direction === 'æ”¶å…¥').reduce((sum, t) => sum + t.amount, 0);
            const expense = filtered.filter(t => t.direction === 'æ”¯å‡º').reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('totalIncome').textContent = `Â¥${income.toFixed(2)}`;
            document.getElementById('totalExpense').textContent = `Â¥${expense.toFixed(2)}`;
            document.getElementById('netBalance').textContent = `Â¥${(income - expense).toFixed(2)}`;
            document.getElementById('transactionCount').textContent = filtered.length;
        }

        function updateCategories() {
            const filtered = getFilteredTransactions().filter(t => t.direction === 'æ”¯å‡º');
            const categories = {};
            filtered.forEach(t => {
                categories[t.category] = (categories[t.category] || 0) + t.amount;
            });

            const sorted = Object.entries(categories).sort((a, b) => b[1] - a[1]);
            const total = sorted.reduce((sum, [, amount]) => sum + amount, 0);

            const list = document.getElementById('categoryList');
            list.innerHTML = sorted.map(([cat, amount], index) => {
                const percent = (amount / total * 100).toFixed(1);
                const icon = categoryIcons[cat] || 'ğŸ“¦';
                const color = categoryColors[index % categoryColors.length];
                return `
                    <li class="category-item">
                        <div class="category-name">
                            <div class="category-icon" style="background: ${color}20; color: ${color}">${icon}</div>
                            <span>${cat}</span>
                        </div>
                        <div class="category-amount">
                            <div class="amount">Â¥${amount.toFixed(2)}</div>
                            <div class="percent">${percent}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percent}%; background: ${color}"></div>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function updateMerchants() {
            const filtered = getFilteredTransactions().filter(t => t.direction === 'æ”¯å‡º');
            const merchants = {};
            filtered.forEach(t => {
                merchants[t.merchant] = (merchants[t.merchant] || 0) + t.amount;
            });

            const sorted = Object.entries(merchants).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const total = filtered.reduce((sum, t) => sum + t.amount, 0);

            const list = document.getElementById('merchantList');
            list.innerHTML = sorted.map(([merchant, amount], index) => {
                const percent = (amount / total * 100).toFixed(1);
                const color = categoryColors[index % categoryColors.length];
                return `
                    <li class="category-item">
                        <div class="category-name">
                            <div class="category-icon" style="background: ${color}20; color: ${color}">ğŸª</div>
                            <span style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${merchant}</span>
                        </div>
                        <div class="category-amount">
                            <div class="amount">Â¥${amount.toFixed(2)}</div>
                            <div class="percent">${percent}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percent}%; background: ${color}"></div>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function updateTransactionList() {
            const filtered = getFilteredTransactions();
            const list = document.getElementById('transactionList');
            
            list.innerHTML = filtered.sort((a, b) => new Date(b.time) - new Date(a.time)).map(t => {
                const isExpense = t.direction === 'æ”¯å‡º';
                const icon = categoryIcons[t.category] || 'ğŸ“¦';
                return `
                    <div class="transaction-item">
                        <div class="category-icon" style="background: #f0f0f0; margin-right: 12px;">${icon}</div>
                        <div class="transaction-info">
                            <div class="transaction-title">${t.merchant || t.product || t.type}</div>
                            <div class="transaction-meta">${t.time} Â· ${t.category}</div>
                        </div>
                        <div class="transaction-amount ${isExpense ? 'expense' : 'income'}">
                            ${isExpense ? '-' : '+'}Â¥${t.amount.toFixed(2)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterTransactions(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', 
                    (type === 'all' && btn.textContent === 'å…¨éƒ¨') ||
                    (type === 'expense' && btn.textContent === 'æ”¯å‡º') ||
                    (type === 'income' && btn.textContent === 'æ”¶å…¥'));
            });
            updateStats();
            updateTransactionList();
        }

        function openModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        function addTransaction() {
            const type = document.getElementById('newType').value;
            const amount = parseFloat(document.getElementById('newAmount').value);
            const merchant = document.getElementById('newMerchant').value;
            const category = document.getElementById('newCategory').value;
            const note = document.getElementById('newNote').value;

            if (!amount || amount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
                return;
            }

            const newTransaction = {
                time: new Date().toLocaleString('zh-CN'),
                type: 'æ‰‹åŠ¨è®°è´¦',
                merchant: merchant || category,
                product: note,
                direction: type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥',
                amount: amount,
                category: category
            };

            allTransactions.push(newTransaction);
            closeModal();
            updateUI();

            // æ¸…ç©ºè¡¨å•
            document.getElementById('newAmount').value = '';
            document.getElementById('newMerchant').value = '';
            document.getElementById('newNote').value = '';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('addModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>
</body>
</html>
